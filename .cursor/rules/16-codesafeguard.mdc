---
description: SAFEGUARD: Sistema de ValidaciÃ³n de CÃ³digo
globs: src/core/safeguard/*
alwaysApply: true
---
# CODESAFEGUARD - ValidaciÃ³n Enterprise de CÃ³digo Generado

## CONCEPTO

CodeSafeGuard valida TODO el cÃ³digo generado usando **TypeScript Compiler API** (no regex). Esto garantiza que el cÃ³digo generado sea:
- âœ… SintÃ¡cticamente correcto
- âœ… Libre de patrones obsoletos
- âœ… Seguro (sin XSS, eval, etc.)
- âœ… Performante
- âœ… Accesible

---

## UBICACIÃ“N

`src/core/safeguard/validator.ts`

---

## API

```typescript
interface ValidationResult {
  isValid: boolean;      // true si no hay errores
  errors: string[];      // Errores que BLOQUEAN
  warnings: string[];    // Warnings que NO bloquean
}

class CodeSafeGuard {
  static validate(code: string, targetTech: 'react' | 'angular' | 'vue'): ValidationResult;
  static generateRepairPrompt(code: string, errors: string[]): string;
}
```

---

## VALIDACIONES

### 1. ValidaciÃ³n SintÃ¡ctica (TypeScript Compiler API)

```typescript
private static validateSyntax(code: string): string[] {
  const sourceFile = ts.createSourceFile(
    'temp.tsx',
    code,
    ts.ScriptTarget.Latest,
    true,
    ts.ScriptKind.TSX
  );
  
  const program = ts.createProgram(['temp.tsx'], {
    noEmit: true,
    strict: true,
    jsx: ts.JsxEmit.React,
    target: ts.ScriptTarget.ESNext,
    module: ts.ModuleKind.ESNext
  }, host);
  
  const diagnostics = ts.getPreEmitDiagnostics(program);
  return diagnostics.map(d => `Syntax Error: ${d.messageText}`);
}
```

**Detecta**:
- âŒ Errores de sintaxis
- âŒ Imports incorrectos
- âŒ JSX malformado
- âŒ TypeScript errors (strict mode)

---

### 2. Patrones Obsoletos (React)

```typescript
private static detectObsoletePatterns(code: string, targetTech: string): string[] {
  const errors: string[] = [];
  
  if (targetTech === 'react') {
    // Class Components
    if (/class\s+\w+\s+extends\s+(React\.)?Component/g.test(code)) {
      errors.push('Class Component detected (use Functional Component + Hooks)');
    }
    
    // Lifecycle methods
    if (/componentDidMount|componentWillMount|componentWillReceiveProps/g.test(code)) {
      errors.push('Legacy lifecycle methods detected (use useEffect)');
    }
    
    // createRef
    if (/React\.createRef|createRef/g.test(code)) {
      errors.push('createRef detected (use useRef)');
    }
  }
  
  if (targetTech === 'angular') {
    // NgModule
    if (/@NgModule/g.test(code)) {
      errors.push('NgModule detected (use standalone: true)');
    }
    
    // Old control flow
    if (/\*ngIf|\*ngFor/g.test(code)) {
      errors.push('Old control flow detected (use @if, @for)');
    }
  }
  
  return errors;
}
```

**Detecta (React)**:
- âŒ `class X extends Component`
- âŒ `componentDidMount`, `componentWillMount`, `componentWillReceiveProps`
- âŒ `React.createRef()`, `createRef()`

**Detecta (Angular)**:
- âŒ `@NgModule` (usar standalone)
- âŒ `*ngIf`, `*ngFor` (usar @if, @for)

---

### 3. Problemas de Seguridad

```typescript
private static detectSecurityIssues(code: string): string[] {
  const errors: string[] = [];
  
  // XSS: dangerouslySetInnerHTML sin sanitizar
  if (/dangerouslySetInnerHTML/.test(code) && !/DOMPurify/.test(code)) {
    errors.push('dangerouslySetInnerHTML without DOMPurify (XSS risk)');
  }
  
  // eval()
  if (/\beval\s*\(/.test(code)) {
    errors.push('eval() detected (security risk)');
  }
  
  // Function constructor
  if (/new\s+Function\s*\(/.test(code)) {
    errors.push('Function constructor detected (security risk)');
  }
  
  // innerHTML directo
  if (/\.innerHTML\s*=/.test(code)) {
    errors.push('innerHTML assignment without sanitization (XSS risk)');
  }
  
  return errors;
}
```

**Detecta**:
- âŒ `dangerouslySetInnerHTML` sin DOMPurify
- âŒ `eval(...)` 
- âŒ `new Function(...)`
- âŒ `.innerHTML = ...`

---

### 4. Problemas de Performance (Warnings)

```typescript
private static detectPerformanceIssues(code: string): string[] {
  const warnings: string[] = [];
  
  // Inline functions en JSX
  if (/onClick=\{.*?=>.*?\}/g.test(code)) {
    warnings.push('Inline arrow functions in JSX (consider useCallback)');
  }
  
  // Array.map sin key
  if (/\.map\(.*?=>\s*</.test(code) && !/key=/g.test(code)) {
    warnings.push('Array.map without key prop');
  }
  
  return warnings;
}
```

**Detecta**:
- âš ï¸ `onClick={() => ...}` (inline functions)
- âš ï¸ `.map(x => <div>)` sin `key`

---

### 5. Problemas de Accesibilidad (Warnings)

```typescript
private static detectAccessibilityIssues(code: string): string[] {
  const warnings: string[] = [];
  
  // img sin alt
  if (/<img[^>]*src=/g.test(code) && !/<img[^>]*alt=/g.test(code)) {
    warnings.push('img tag without alt attribute');
  }
  
  // button con solo icono sin aria-label
  if (/<button[^>]*>\s*<(?:Icon|Svg|i)/g.test(code) && !/<button[^>]*aria-label=/g.test(code)) {
    warnings.push('Icon button without aria-label');
  }
  
  // div con onClick pero sin role
  if (/<div[^>]*onClick/g.test(code) && !/<div[^>]*role=/g.test(code)) {
    warnings.push('Interactive div without role attribute');
  }
  
  return warnings;
}
```

**Detecta**:
- âš ï¸ `<img src="...">` sin `alt`
- âš ï¸ `<button><Icon/></button>` sin `aria-label`
- âš ï¸ `<div onClick={...}>` sin `role`

---

## FLUJO DE VALIDACIÃ“N

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLMService.generate(prompt)                                     â”‚
â”‚   â†“                                                              â”‚
â”‚ generatedCode = "..."                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CodeSafeGuard.validate(generatedCode, 'react')                  â”‚
â”‚   â”‚                                                              â”‚
â”‚   â”œâ”€ validateSyntax(code)        â†’ TypeScript Compiler API     â”‚
â”‚   â”œâ”€ detectObsoletePatterns(code) â†’ Regex patterns             â”‚
â”‚   â”œâ”€ detectSecurityIssues(code)   â†’ Security checks            â”‚
â”‚   â”œâ”€ detectPerformanceIssues(code) â†’ Performance warnings      â”‚
â”‚   â””â”€ detectAccessibilityIssues(code) â†’ A11y warnings           â”‚
â”‚                                                                  â”‚
â”‚   Return: { isValid, errors, warnings }                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Si isValid === true:                                            â”‚
â”‚   â†’ Guardar archivo                                             â”‚
â”‚                                                                  â”‚
â”‚ Si isValid === false:                                           â”‚
â”‚   â†’ LLMService.repair(code, errors, framework, attempt)        â”‚
â”‚   â†’ CodeSafeGuard.validate(repairedCode)                       â”‚
â”‚   â†’ Repetir hasta 3 veces                                       â”‚
â”‚   â†’ Si falla 3 veces: Fallback con fixes conocidos             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## AUTO-REPARACIÃ“N

### Prompt de ReparaciÃ³n

```typescript
static generateRepairPrompt(code: string, errors: string[]): string {
  return `# ğŸ”§ REPAIR REQUIRED

El cÃ³digo generado tiene los siguientes problemas:

${errors.map((e, i) => `${i + 1}. âŒ ${e}`).join('\n')}

## CÃ³digo Original:

\`\`\`typescript
${code}
\`\`\`

## Instrucciones:

Corrige TODOS los problemas listados arriba. Responde SOLO con el cÃ³digo corregido, sin explicaciones.

## CÃ³digo Corregido:

\`\`\`typescript
// Tu cÃ³digo aquÃ­
\`\`\``;
}
```

### LLMService.repair()

```typescript
async repair(
  code: string,
  errors: string[],
  targetTech: string,
  attempt: number
): Promise<string> {
  const prompt = `# ğŸ”§ CODE REPAIR - Attempt ${attempt}/3

## âŒ Validation Errors Detected
${errors.map((e, i) => `${i + 1}. ${e}`).join('\n')}

## ğŸ› Problematic Code
\`\`\`tsx
${code}
\`\`\`

## âœ… Your Task
1. Fix ALL errors listed above
2. Maintain the original functionality
3. Keep the same component structure
4. Use modern best practices
5. Return ONLY the fixed code

## ğŸ¯ Common Fixes
- Class Components â†’ Functional Components + Hooks
- dangerouslySetInnerHTML â†’ Use DOMPurify
- Missing alt â†’ Add descriptive alt text
- eval() â†’ Remove or use safe alternative

## ğŸ“¤ Output
\`\`\`tsx
// Fixed code here
\`\`\``;

  return this.generate(prompt);
}
```

---

## FALLBACK CONOCIDOS

Si LLM falla 3 veces, se aplican fixes automÃ¡ticos:

```typescript
// Fix 1: Class Component â†’ Functional (regex simple)
if (errors.some(e => e.includes('Class Component'))) {
  repairedCode = repairedCode.replace(
    /class\s+(\w+)\s+extends\s+React\.Component/g,
    'export const $1: React.FC = () =>'
  );
}

// Fix 2: dangerouslySetInnerHTML â†’ Agregar DOMPurify
if (errors.some(e => e.includes('dangerouslySetInnerHTML'))) {
  if (!repairedCode.includes('DOMPurify')) {
    repairedCode = "import DOMPurify from 'dompurify';\n" + repairedCode;
    repairedCode = repairedCode.replace(
      /dangerouslySetInnerHTML={{__html:\s*(.+?)}}/g,
      'dangerouslySetInnerHTML={{__html: DOMPurify.sanitize($1)}}'
    );
  }
}

// Fix 3: eval() â†’ Comentar
if (errors.some(e => e.includes('eval()'))) {
  repairedCode = repairedCode.replace(/eval\(/g, '// REMOVED: eval(');
}
```

---

## EJEMPLO COMPLETO

### Input (CÃ³digo ProblemÃ¡tico)
```typescript
class UserList extends React.Component {
  state = { users: [] };
  
  componentDidMount() {
    eval('console.log("hello")'); // âŒ eval
    fetch('/api').then(r => this.setState({ users: r }));
  }
  
  render() {
    return (
      <div>
        <img src="/logo.png" /> {/* âŒ sin alt */}
        <div dangerouslySetInnerHTML={{__html: data}} /> {/* âŒ sin DOMPurify */}
        {this.state.users.map(u => <div>{u.name}</div>)} {/* âŒ sin key */}
      </div>
    );
  }
}
```

### Validation Result
```typescript
{
  isValid: false,
  errors: [
    "Class Component detected (use Functional Component + Hooks)",
    "Legacy lifecycle methods detected (use useEffect)",
    "eval() detected (security risk)",
    "dangerouslySetInnerHTML without DOMPurify (XSS risk)"
  ],
  warnings: [
    "img tag without alt attribute",
    "Array.map without key prop"
  ]
}
```

### Output (DespuÃ©s de Auto-Repair)
```typescript
import { useState, useEffect } from 'react';
import DOMPurify from 'dompurify';

interface User {
  id: string;
  name: string;
}

export function UserList() {
  const [users, setUsers] = useState<User[]>([]);
  
  useEffect(() => {
    // REMOVED: eval('console.log("hello")');
    fetch('/api')
      .then(r => r.json())
      .then(setUsers);
  }, []);
  
  return (
    <div>
      <img src="/logo.png" alt="Company logo" />
      <div dangerouslySetInnerHTML={{__html: DOMPurify.sanitize(data)}} />
      {users.map(u => <div key={u.id}>{u.name}</div>)}
    </div>
  );
}
```

---

## TABLA DE VALIDACIONES

| CategorÃ­a | PatrÃ³n | Severidad | Auto-Fix |
|-----------|--------|-----------|----------|
| Obsolete | Class Component | ğŸ”´ Error | âœ… LLM |
| Obsolete | Lifecycle methods | ğŸ”´ Error | âœ… LLM |
| Obsolete | createRef | ğŸ”´ Error | âœ… LLM |
| Security | dangerouslySetInnerHTML | ğŸ”´ Error | âœ… LLM + Fallback |
| Security | eval() | ğŸ”´ Error | âœ… Fallback |
| Security | new Function | ğŸ”´ Error | âœ… LLM |
| Security | innerHTML = | ğŸ”´ Error | âœ… LLM |
| Performance | Inline functions | ğŸŸ¡ Warning | âŒ |
| Performance | map sin key | ğŸŸ¡ Warning | âŒ |
| A11y | img sin alt | ğŸŸ¡ Warning | âŒ |
| A11y | button sin aria-label | ğŸŸ¡ Warning | âŒ |
| A11y | div onClick sin role | ğŸŸ¡ Warning | âŒ |
