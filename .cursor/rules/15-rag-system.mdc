---
description: RAG: Sistema de Knowledge Graph y Embeddings
globs: src/core/rag/*
alwaysApply: true
---
# SISTEMA RAG ENTERPRISE - DocumentaciÃ³n Completa

## CONCEPTO

RAG (Retrieval-Augmented Generation) permite que el LLM entienda el CONTEXTO COMPLETO del proyecto antes de generar cÃ³digo.

### Sin RAG (Malo)
```
LLM ve: "Migrar LoginForm.jsp"
LLM genera: <LoginButton>, <LoginInput> (componentes nuevos)
Problema: El proyecto YA tiene <Button>, <TextInput> â†’ DUPLICACIÃ“N
```

### Con RAG (Bueno)
```
LLM ve: "Migrar LoginForm.jsp" + "Componentes existentes: Button, TextInput"
LLM genera: Usa <Button>, <TextInput> existentes
Resultado: Sin duplicaciÃ³n, coherencia con el proyecto
```

---

## ARQUITECTURA DEL RAG

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. INDEXACIÃ“N (Una vez por proyecto)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CodebaseIndexer.index(projectRoot)                              â”‚
â”‚   â”‚                                                              â”‚
â”‚   â”œâ”€ glob('**/*.{js,jsx,ts,tsx}')                               â”‚
â”‚   â”‚   â””â”€ Excluye: node_modules, dist, build, tests              â”‚
â”‚   â”‚                                                              â”‚
â”‚   â”œâ”€ EntityExtractor.extractFromFile(filePath)                  â”‚
â”‚   â”‚   â””â”€ TypeScript Compiler API â†’ AST parsing                  â”‚
â”‚   â”‚   â””â”€ Extrae: functions, components, hooks, interfaces       â”‚
â”‚   â”‚                                                              â”‚
â”‚   â””â”€ EmbeddingsEngine.generateCodeEmbedding(entity)             â”‚
â”‚       â””â”€ OpenAI text-embedding-3-small (384 dims)               â”‚
â”‚       â””â”€ O Gemini embedding-001                                  â”‚
â”‚       â””â”€ O TF-IDF local (fallback)                              â”‚
â”‚                                                                  â”‚
â”‚ Output: KnowledgeGraph con entidades + vectores                 â”‚
â”‚ Persistido en: .osmosis/knowledge-graph.json                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. BÃšSQUEDA SEMÃNTICA (Por cada migraciÃ³n)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ContextInjector.enrichPrompt(prompt, migrationContext)          â”‚
â”‚   â”‚                                                              â”‚
â”‚   â”œâ”€ KnowledgeGraph.search("login form component", topK=5)      â”‚
â”‚   â”‚   â””â”€ Genera embedding de la query                           â”‚
â”‚   â”‚   â””â”€ Cosine similarity con todos los vectores               â”‚
â”‚   â”‚   â””â”€ Retorna top 5 entidades mÃ¡s similares                  â”‚
â”‚   â”‚                                                              â”‚
â”‚   â””â”€ Inyecta en prompt:                                         â”‚
â”‚       â”œâ”€ Componentes similares existentes                       â”‚
â”‚       â”œâ”€ Utilidades disponibles                                 â”‚
â”‚       â”œâ”€ Hooks y patterns del proyecto                          â”‚
â”‚       â””â”€ Restricciones del proyecto                             â”‚
â”‚                                                                  â”‚
â”‚ Output: Prompt enriquecido con contexto del proyecto            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## COMPONENTES DETALLADOS

### EntityExtractor (`src/core/rag/EntityExtractor.ts`)

**Usa TypeScript Compiler API (no regex)**

```typescript
interface CodeEntity {
  id: string;                    // Nombre Ãºnico
  type: 'function' | 'component' | 'hook' | 'constant' | 'interface';
  filePath: string;              // Ruta del archivo
  sourceCode: string;            // CÃ³digo completo
  docstring?: string;            // JSDoc/comentarios
  signature?: string;            // Type signature
  metadata: {
    lineStart: number;
    lineEnd: number;
    complexity: number;          // Complejidad ciclomÃ¡tica
    dependencies: string[];      // Imports usados
  };
}
```

**DetecciÃ³n de Tipos**:
```typescript
// Component: FunciÃ³n con nombre PascalCase que retorna JSX
function Button() { return <button>...</button> }  // type: 'component'
const Card = () => <div>...</div>                   // type: 'component'

// Hook: FunciÃ³n que empieza con "use"
function useAuth() { ... }                         // type: 'hook'
const useFetch = () => { ... }                     // type: 'hook'

// Function: Todo lo demÃ¡s
function calculateTax() { ... }                    // type: 'function'
const formatDate = () => { ... }                   // type: 'function'

// Interface
interface UserProps { ... }                        // type: 'interface'

// Constant: ExportaciÃ³n de objeto/array
export const COLORS = { ... }                      // type: 'constant'
```

---

### EmbeddingsEngine (`src/core/rag/EmbeddingsEngine.ts`)

**Proveedores Soportados**:

| Provider | Modelo | Dimensiones | Costo | PrecisiÃ³n |
|----------|--------|-------------|-------|-----------|
| OpenAI | text-embedding-3-small | 384 | $0.02/1M tokens | ~95% |
| Gemini | embedding-001 | 768 | Gratis (quota) | ~90% |
| Local | TF-IDF | Variable | Gratis | ~75% |

**ConfiguraciÃ³n**:
```typescript
const engine = new EmbeddingsEngine({
  provider: 'openai',                    // 'openai' | 'gemini' | 'local'
  apiKey: process.env.OPENAI_API_KEY,
  model: 'text-embedding-3-small'        // Solo para OpenAI
});
```

**GeneraciÃ³n de Embedding**:
```typescript
const embedding = await engine.generateCodeEmbedding({
  sourceCode: "function calculateTax(amount, rate) { return amount * rate; }",
  docstring: "Calcula el impuesto basado en monto y tasa",
  signature: "(amount: number, rate: number): number"
});

// embedding = [0.123, -0.456, 0.789, ...] (384 nÃºmeros)
```

**Similitud Coseno**:
```typescript
const similarity = engine.cosineSimilarity(vec1, vec2);
// 0.95 = Muy similar
// 0.50 = Algo similar  
// 0.10 = Poco similar
```

---

### KnowledgeGraph (`src/core/rag/KnowledgeGraph.ts`)

**Estructura**:
```typescript
class KnowledgeGraph {
  private entities: Map<string, CodeEntity>;
  private vectors: Map<string, number[]>;
  private embeddingsEngine: EmbeddingsEngine;
  
  // Agregar entidad
  async addEntity(entity: CodeEntity): Promise<void>;
  
  // BÃºsqueda semÃ¡ntica
  async search(query: string, topK: number): Promise<CodeEntity[]>;
  
  // Buscar componentes similares
  async findSimilarComponents(name: string, sourceCode?: string): Promise<CodeEntity[]>;
  
  // Contexto para migraciÃ³n
  async getRelevantContext(filePath: string, legacyCode: string): Promise<{
    components: CodeEntity[];
    utilities: CodeEntity[];
    patterns: CodeEntity[];
  }>;
  
  // Persistencia
  async save(projectRoot: string): Promise<void>;
  static async load(projectRoot: string, config: EmbeddingConfig): Promise<KnowledgeGraph | null>;
  
  // Stats
  getStats(): {
    totalEntities: number;
    totalVectors: number;
    byType: Record<string, number>;
    hasEmbeddings: boolean;
  };
}
```

**Persistencia**:
```json
// .osmosis/knowledge-graph.json
{
  "version": "1.0",
  "entities": [
    {
      "id": "Button",
      "type": "component",
      "filePath": "src/components/Button.tsx",
      "sourceCode": "export const Button = ({ label, onClick }) => ...",
      "docstring": "Primary button component",
      "signature": "({ label: string, onClick: () => void }): JSX.Element"
    }
  ],
  "vectors": {
    "Button": [0.123, -0.456, ...]
  }
}
```

---

### CodebaseIndexer (`src/core/rag/CodebaseIndexer.ts`)

**Flujo de IndexaciÃ³n**:
```typescript
const indexer = new CodebaseIndexer(projectRoot, {
  provider: 'openai',
  apiKey: process.env.OPENAI_API_KEY
});

const knowledgeGraph = await indexer.index();
// 1. Busca archivos: glob('**/*.{js,jsx,ts,tsx}')
// 2. Extrae entidades de cada archivo
// 3. Genera embeddings en batches de 10
// 4. Construye KnowledgeGraph
// 5. Guarda en .osmosis/

await knowledgeGraph.save(projectRoot);
```

**Optimizaciones**:
- âœ… Procesa archivos en paralelo (batches de 10)
- âœ… Cache de embeddings (no regenera iguales)
- âœ… Detecta si cache estÃ¡ desactualizado
- âœ… Ignora archivos grandes (>100KB)

---

### ContextInjector (`src/core/rag/ContextInjector.ts`)

**Enriquece prompts con contexto del proyecto**:

```typescript
const injector = new ContextInjector(knowledgeGraph);

const enrichedPrompt = await injector.enrichPrompt(basePrompt, {
  fileName: "LoginForm.jsp",
  filePath: "/legacy/login/LoginForm.jsp",
  sourceCode: jspCode,
  legacyLanguage: "jsp",
  targetFramework: "react"
});
```

**SecciÃ³n Inyectada en el Prompt**:
```markdown
## ğŸ” COMPONENTES SIMILARES EXISTENTES

âš ï¸ **IMPORTANTE**: Los siguientes componentes ya existen en el proyecto.
**NO crees componentes duplicados**. Reutiliza estos o extiÃ©ndelos.

### 1. `Button` (src/components/Button.tsx)
   **DescripciÃ³n**: Primary button component
   **Signature**: `({ label: string, onClick: () => void }): JSX.Element`

   ```typescript
   export const Button = ({ label, onClick }) => {
     return <button onClick={onClick}>{label}</button>;
   };
   ```

### 2. `TextInput` (src/components/TextInput.tsx)
   **DescripciÃ³n**: Controlled text input
   **Signature**: `({ value: string, onChange: (v: string) => void }): JSX.Element`

## âš™ï¸ UTILIDADES DISPONIBLES

- **`validateEmail`** (`src/utils/validation.ts`)
  Validates email format with RFC5322 compliance
  `(email: string): boolean`

- **`hashPassword`** (`src/utils/crypto.ts`)
  Hashes password with bcrypt
  `(password: string): Promise<string>`

## ğŸª HOOKS Y PATTERNS DISPONIBLES

- **`useAuth`** (`src/hooks/useAuth.ts`)
  Authentication hook with JWT management
  `(): { login, logout, user, isAuthenticated }`

- **`useFetch`** (`src/hooks/useFetch.ts`)
  Generic fetch hook with loading/error states
  `<T>(url: string): { data: T, loading, error }`

## âš ï¸ RESTRICCIONES DEL PROYECTO

1. **NO crear componentes desde cero** si existe uno similar
2. **NO usar colores hardcodeados** - usar theme tokens
3. **NO usar Class Components** - solo Functional + Hooks
4. **NO usar any** - definir interfaces TypeScript
5. **USAR los hooks existentes** antes de crear nuevos
```

---

## PERFORMANCE

### IndexaciÃ³n Inicial

| TamaÃ±o Proyecto | Archivos | Entidades | Tiempo (OpenAI) | Tiempo (Local) |
|-----------------|----------|-----------|-----------------|----------------|
| PequeÃ±o | 50 | ~200 | 30s | 10s |
| Mediano | 500 | ~2,000 | 3m | 1m |
| Grande | 2,000 | ~10,000 | 12m | 4m |

### Con Cache (Subsecuentes)

| OperaciÃ³n | Tiempo |
|-----------|--------|
| Cargar KnowledgeGraph | <0.5s |
| BÃºsqueda semÃ¡ntica | <50ms |
| Enriquecer prompt | <100ms |

---

## COSTOS

### OpenAI Embeddings
- Modelo: `text-embedding-3-small`
- Costo: $0.02 por 1M tokens
- Proyecto tÃ­pico (2,000 archivos): ~$0.50
- **Con cache**: Solo se paga UNA vez

### Gemini (Alternativa)
- Gratis con quota
- Necesita `GEMINI_API_KEY`

### Local (Sin costo)
- TF-IDF
- Menos preciso (~75% vs ~95%)
- Funciona sin API keys

---

## CONFIGURACIÃ“N

### Con OpenAI (Recomendado)
```bash
export OPENAI_API_KEY="sk-..."
osmosis analyze --dir ./project
```

### Con Gemini
```bash
export GEMINI_API_KEY="..."
osmosis analyze --dir ./project
```

### Sin API Keys (Local)
```bash
# No exportar ninguna key
osmosis analyze --dir ./project
# UsarÃ¡ TF-IDF automÃ¡ticamente
```

---

## INVALIDAR CACHE

```bash
rm -rf .osmosis/
osmosis analyze --dir ./project
```

---

## FAQ

**Â¿Se envÃ­a mi cÃ³digo a OpenAI?**
Solo snippets para generar embeddings (vectores numÃ©ricos). Los embeddings se guardan localmente.

**Â¿Puedo usar embeddings locales?**
SÃ­, sin API key usa TF-IDF. Menos preciso pero funcional.

**Â¿Funciona con otros lenguajes?**
Por ahora solo JS/TS. Python y Java prÃ³ximamente.

**Â¿CÃ³mo sÃ© si RAG estÃ¡ funcionando?**
El log dice "Enriqueciendo prompt con X componentes similares".
