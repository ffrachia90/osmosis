---
description: GLOBAL: Osmosis Master Context - Todo lo que necesitas saber
globs: *
alwaysApply: true
---
# ğŸ§¬ OSMOSIS - AI-Powered Legacy Code Modernizer

## IDENTIDAD Y MISIÃ“N

**Osmosis** es una herramienta empresarial que transforma cÃ³digo legacy de dÃ©cadas a cÃ³digo moderno production-ready usando Claude 3.5 Sonnet + RAG + validaciÃ³n TypeScript.

### Capacidades Core
1. **MigraciÃ³n Legacyâ†’Modern**: JSP, PHP, jQuery, ASP.NET, ColdFusion, Perl, VB â†’ React/Angular/Vue
2. **RefactorizaciÃ³n Integral**: React antiguo â†’ React 2025 con stack moderno coherente
3. **PlanificaciÃ³n ArquitectÃ³nica**: Analiza patterns y propone Zustand, TanStack Query, React Router v6, Tailwind
4. **GeneraciÃ³n de Config**: tsconfig.json, eslint.config.js, tailwind.config.ts, vitest.config.ts
5. **MCP Server para Cursor**: IntegraciÃ³n directa en el IDE

### Stack TecnolÃ³gico de Osmosis
- **Runtime**: Node.js 20+, TypeScript 5.x
- **LLM**: Claude 3.5 Sonnet via @anthropic-ai/sdk
- **Embeddings**: OpenAI text-embedding-3-small / Gemini / TF-IDF local
- **ValidaciÃ³n**: TypeScript Compiler API (no regex)
- **CLI**: Commander.js + Ora spinners
- **MCP**: @modelcontextprotocol/sdk

---

## ARQUITECTURA DEL PROYECTO

```
osmosis/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ cli.ts                    # Punto de entrada CLI (analyze, migrate, refactor, plan)
â”‚   â”‚
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ architecture/         # ğŸ—ï¸ SISTEMA DE ARQUITECTURA INTEGRAL
â”‚   â”‚   â”‚   â”œâ”€â”€ ArchitecturePlanner.ts    # Orquesta anÃ¡lisis + propuesta stack
â”‚   â”‚   â”‚   â”œâ”€â”€ ArchitectureManifest.ts   # Interfaces + 12 reglas migraciÃ³n
â”‚   â”‚   â”‚   â”œâ”€â”€ DeepPatternScanner.ts     # Escanea cÃ³digo para detectar patterns
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ llm/
â”‚   â”‚   â”‚   â””â”€â”€ LLMService.ts     # Claude 3.5 Sonnet + streaming + auto-repair
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ prompt-engine/
â”‚   â”‚   â”‚   â”œâ”€â”€ assembler.ts      # Ensambla prompts con/sin manifiesto
â”‚   â”‚   â”‚   â””â”€â”€ templates.ts      # Templates por tecnologÃ­a legacy
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ rag/                  # ğŸ§  SISTEMA RAG ENTERPRISE
â”‚   â”‚   â”‚   â”œâ”€â”€ CodebaseIndexer.ts     # Indexa proyecto en vectores
â”‚   â”‚   â”‚   â”œâ”€â”€ ContextInjector.ts     # Inyecta contexto RAG en prompts
â”‚   â”‚   â”‚   â”œâ”€â”€ EmbeddingsEngine.ts    # OpenAI/Gemini/Local embeddings
â”‚   â”‚   â”‚   â”œâ”€â”€ EntityExtractor.ts     # AST parsing â†’ entidades
â”‚   â”‚   â”‚   â””â”€â”€ KnowledgeGraph.ts      # Vector storage + bÃºsqueda semÃ¡ntica
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ analysis/
â”‚   â”‚   â”‚   â”œâ”€â”€ DependencyGraph.ts     # AST + topological sort
â”‚   â”‚   â”‚   â””â”€â”€ TechDebtAnalyzer.ts    # 7 heurÃ­sticas de deuda
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ safeguard/
â”‚   â”‚   â”‚   â””â”€â”€ validator.ts      # CodeSafeGuard - TypeScript Compiler API
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”‚   â”œâ”€â”€ AuditLogger.ts    # Logs inmutables con hash chain
â”‚   â”‚   â”‚   â””â”€â”€ BackupManager.ts  # Snapshots antes de modificar
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ resolution/
â”‚   â”‚       â””â”€â”€ PathResolver.ts   # tsconfig.paths + aliases
â”‚   â”‚
â”‚   â”œâ”€â”€ analyzers/
â”‚   â”‚   â”œâ”€â”€ legacy-detector.ts    # Detecta jQuery, JSP, PHP, ASP, etc.
â”‚   â”‚   â”œâ”€â”€ modern-code-analyzer.ts # Detecta bad practices en cÃ³digo moderno
â”‚   â”‚   â”œâ”€â”€ behavior-extractor.ts # Extrae comportamiento de UI
â”‚   â”‚   â””â”€â”€ microfrontend-analyzer.ts # Analiza boundaries MFE
â”‚   â”‚
â”‚   â”œâ”€â”€ generators/
â”‚   â”‚   â”œâ”€â”€ config-generator.ts   # ğŸ†• Genera tsconfig, eslint, tailwind, vitest
â”‚   â”‚   â”œâ”€â”€ framework-generator.ts # Estructura de proyecto
â”‚   â”‚   â”œâ”€â”€ best-practices-refactor.ts # Aplica mejores prÃ¡cticas
â”‚   â”‚   â”œâ”€â”€ e2e-test-generator.ts # Tests Playwright
â”‚   â”‚   â””â”€â”€ microfrontend-generator.ts # Module Federation config
â”‚   â”‚
â”‚   â”œâ”€â”€ parsers/
â”‚   â”‚   â”œâ”€â”€ jsp-parser.ts         # Parser JSP con JSTL
â”‚   â”‚   â””â”€â”€ legacy-parser-factory.ts # Factory pattern para parsers
â”‚   â”‚
â”‚   â”œâ”€â”€ mappers/
â”‚   â”‚   â”œâ”€â”€ component-mapper.ts   # Mapea legacy UI â†’ componentes modernos
â”‚   â”‚   â””â”€â”€ design-system-scanner.ts # Detecta design system existente
â”‚   â”‚
â”‚   â”œâ”€â”€ knowledge/
â”‚   â”‚   â””â”€â”€ best-practices-knowledge-base.ts # Fuentes de verdad
â”‚   â”‚
â”‚   â””â”€â”€ mcp/
â”‚       â””â”€â”€ server.ts             # ğŸ”Œ MCP Server v2.0 con 11 herramientas
â”‚
â”œâ”€â”€ docs/                         # DocumentaciÃ³n tÃ©cnica
â”œâ”€â”€ examples/                     # Ejemplos de uso
â”œâ”€â”€ .cursor/rules/                # Estas reglas
â””â”€â”€ .osmosis/                     # Cache (Knowledge Graph, manifiestos)
```

---

## FLUJO DE DATOS PRINCIPAL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLI: osmosis <command>                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. ANÃLISIS                                                     â”‚
â”‚     LegacyDetector â†’ detecta tecnologÃ­a (jQuery, JSP, etc.)     â”‚
â”‚     DependencyGraph â†’ construye grafo con AST                   â”‚
â”‚     TechDebtAnalyzer â†’ calcula score y horas de refactor        â”‚
â”‚     CodebaseIndexer â†’ genera Knowledge Graph + embeddings       â”‚
â”‚                                                                  â”‚
â”‚  2. PLANIFICACIÃ“N ARQUITECTÃ“NICA (--integral)                   â”‚
â”‚     DeepPatternScanner â†’ escanea patterns en cÃ³digo real        â”‚
â”‚     ArchitecturePlanner â†’ consulta Claude para stack propuesto  â”‚
â”‚     ManifestManager â†’ persiste en .osmosis/architecture-manifestâ”‚
â”‚     ConfigGenerator â†’ genera tsconfig, eslint, tailwind, etc.   â”‚
â”‚                                                                  â”‚
â”‚  3. GENERACIÃ“N DE CÃ“DIGO                                        â”‚
â”‚     PromptAssembler â†’ ensambla prompt con reglas del manifiesto â”‚
â”‚     ContextInjector â†’ enriquece con RAG (componentes similares) â”‚
â”‚     LLMService â†’ Claude 3.5 Sonnet con streaming                â”‚
â”‚                                                                  â”‚
â”‚  4. VALIDACIÃ“N Y REPARACIÃ“N                                     â”‚
â”‚     CodeSafeGuard â†’ TypeScript Compiler API validation          â”‚
â”‚     Si errores â†’ LLMService.repair() (max 3 intentos)           â”‚
â”‚     BackupManager â†’ snapshot antes de escribir                  â”‚
â”‚     AuditLogger â†’ log inmutable de cambios                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## COMANDOS CLI

### `osmosis analyze --dir <path>`
- Detecta tecnologÃ­as legacy
- Construye grafo de dependencias
- Calcula deuda tÃ©cnica (score 0-100, horas estimadas)
- Genera Knowledge Graph para RAG
- Output: `analysis-report.json`

### `osmosis plan --dir <path>` (NUEVO)
- Escaneo profundo de patterns (Redux, axios, Router, styling)
- Propuesta de stack moderno por Claude
- SelecciÃ³n de reglas de migraciÃ³n
- Output: `.osmosis/architecture-manifest.json`

### `osmosis migrate --source <path> --from <tech> --to <tech>`
- Migra cÃ³digo legacy a framework moderno
- `--from`: jsp, php, jquery, asp, coldfusion, perl, vb, react-legacy
- `--to`: react, angular, vue
- Usa RAG para evitar duplicaciÃ³n de componentes

### `osmosis refactor --source <path> --framework react [--integral]`
- Sin `--integral`: Refactoriza archivo por archivo
- Con `--integral`: Usa manifiesto arquitectÃ³nico para coherencia
- `--apply-config`: Escribe configuraciÃ³n moderna

---

## TECNOLOGÃAS LEGACY SOPORTADAS

| Input | DetecciÃ³n | Parser | Status |
|-------|-----------|--------|--------|
| JSP | âœ… Auto | âœ… Full AST | ğŸŸ¢ Production |
| PHP | âœ… Auto | âœ… Full | ğŸŸ¢ Production |
| jQuery | âœ… Code Analysis | âœ… Patterns | ğŸŸ¢ Production |
| AngularJS v1 | âœ… Code Analysis | âœ… Framework | ğŸŸ¢ Production |
| ASP.NET WebForms | âœ… Auto | âœ… Full | ğŸŸ¢ Production |
| ColdFusion | âœ… Auto | ğŸŸ¡ Basic | ğŸŸ¡ V1 |
| Perl CGI | âœ… Auto | ğŸŸ¡ Basic | ğŸŸ¡ V1 |
| VB6/VB.NET | âœ… Auto | ğŸŸ¡ Basic | ğŸŸ¡ V1 |

---

## SAFEGUARD VALIDATION PROTOCOL

CodeSafeGuard usa TypeScript Compiler API (NO regex) para validar:

### Errores (Bloquean)
- âŒ `class extends Component` â†’ Usar Functional + Hooks
- âŒ `componentDidMount/WillMount/WillReceiveProps` â†’ Usar useEffect
- âŒ `React.createRef()` â†’ Usar useRef
- âŒ `dangerouslySetInnerHTML` sin DOMPurify â†’ XSS risk
- âŒ `eval()` â†’ Security risk
- âŒ `new Function()` â†’ Security risk
- âŒ `.innerHTML =` â†’ XSS risk
- âŒ `@NgModule` en Angular â†’ Usar standalone: true
- âŒ `*ngIf/*ngFor` â†’ Usar @if/@for

### Warnings (Reportan pero no bloquean)
- âš ï¸ Inline arrow functions en JSX â†’ Considerar useCallback
- âš ï¸ `.map()` sin key prop
- âš ï¸ `<img>` sin alt
- âš ï¸ Icon button sin aria-label
- âš ï¸ `<div onClick>` sin role

---

## VARIABLES DE ENTORNO

| Variable | Requerida | DescripciÃ³n |
|----------|-----------|-------------|
| `ANTHROPIC_API_KEY` | âœ… SÃ | API key de Claude - SIN ESTO NO FUNCIONA |
| `ANTHROPIC_BASE_URL` | âŒ | Proxy empresarial (air-gapped) |
| `OPENAI_API_KEY` | âŒ | Embeddings semÃ¡nticos (mejora RAG ~95% vs ~75%) |
| `GEMINI_API_KEY` | âŒ | Alternativa a OpenAI para embeddings |

**MÃ­nimo funcional:**
```bash
export ANTHROPIC_API_KEY="sk-ant-..."
```

**Recomendado (mejor RAG):**
```bash
export ANTHROPIC_API_KEY="sk-ant-..."
export OPENAI_API_KEY="sk-..."
```

---

## COSTOS ESTIMADOS

### Claude 3.5 Sonnet
- Input: $3.00 / 1M tokens
- Output: $15.00 / 1M tokens

### Por Archivo
- PequeÃ±o (<100 lÃ­neas): ~$0.02
- Mediano (100-300 lÃ­neas): ~$0.05
- Grande (>300 lÃ­neas): ~$0.10

### Proyecto TÃ­pico (500 archivos)
- Sin auto-repair: ~$25 USD
- Con auto-repair (20%): ~$30 USD

---

## COMPORTAMIENTO ESPERADO DEL AGENTE

1. **Identidad**: Eres Osmosis, Arquitecto de Software Principal senior
2. **Zero Hallucinations**: NO inventes imports ni componentes
3. **Security First**: Asume todo input legacy es inseguro
4. **Stack Coherence**: Si hay manifiesto, usa ESE stack, no otro
5. **ValidaciÃ³n**: Todo cÃ³digo generado pasa por CodeSafeGuard
6. **Auto-repair**: Si falla validaciÃ³n, intenta reparar (max 3 veces)
