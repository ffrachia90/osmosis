---
description: CLI: Referencia Completa de Comandos con Todos los Flags
globs: *
alwaysApply: true
---
# OSMOSIS CLI - Referencia Exhaustiva

## INSTALACIÃ“N Y SETUP

### Clonar y Construir
```bash
git clone https://github.com/tu-usuario/osmosis.git
cd osmosis
npm install
npm run build
```

### Configurar API Keys
```bash
# OBLIGATORIA - Sin esto Osmosis NO funciona
export ANTHROPIC_API_KEY="sk-ant-api03-..."

# OPCIONAL - Mejora precisiÃ³n de RAG de ~75% a ~95%
export OPENAI_API_KEY="sk-..."

# OPCIONAL - Alternativa a OpenAI para embeddings
export GEMINI_API_KEY="..."

# OPCIONAL - Para empresas con proxy
export ANTHROPIC_BASE_URL="https://llm-proxy.company.com"
```

### Verificar InstalaciÃ³n
```bash
# DeberÃ­a mostrar ayuda
npx tsx src/cli.ts --help

# O despuÃ©s de build
node dist/cli.js --help
```

---

## COMANDO: `analyze`

### DescripciÃ³n
Analiza un proyecto legacy completo y genera reporte con:
- TecnologÃ­as detectadas (jQuery, JSP, PHP, etc.)
- Grafo de dependencias
- Knowledge Graph para RAG
- Deuda tÃ©cnica (score, horas, archivos tÃ³xicos)
- Orden de migraciÃ³n recomendado

### Sintaxis
```bash
osmosis analyze --dir <directory> [--output <file>]
```

### Flags

| Flag | Tipo | Requerido | Default | DescripciÃ³n |
|------|------|-----------|---------|-------------|
| `--dir` | string | âœ… | - | Directorio del proyecto a analizar |
| `--output` | string | âŒ | `analysis-report.json` | Archivo de salida para el reporte |

### Ejemplos

```bash
# AnÃ¡lisis bÃ¡sico
osmosis analyze --dir ./legacy-app

# Con output personalizado
osmosis analyze --dir ./my-project --output reports/analysis.json

# Proyecto grande
osmosis analyze --dir /Users/me/enterprise-app --output ./debt-report.json
```

### Output Generado

**Archivos**:
- `analysis-report.json` - Reporte completo
- `.osmosis/knowledge-graph.json` - Knowledge Graph para RAG
- `.osmosis/embeddings-cache.json` - Cache de embeddings

**Consola**:
```
ğŸ“ˆ RESUMEN DEL ANÃLISIS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ Proyecto: /Users/me/legacy-app
ğŸ”§ TecnologÃ­as: jQuery, AngularJS (v1)
ğŸ“„ Total de archivos: 500

âš¡ ESFUERZO DE DEUDA TÃ‰CNICA:
   Puntaje de Salud: 22/100
   Horas de Refactor: 1200h
   Sprints Estimados: ~15 sprints
   Archivos CrÃ­ticos: 45
   RecomendaciÃ³n: Migrar jQuery a React hooks nativos

ğŸ¯ TOP 5 ARCHIVOS MÃS COMPLEJOS:
  ğŸ”¥ dashboard.js
     â”œâ”€ Toxicidad: 95/100
     â””â”€ Problemas: God class, Deep nesting...
```

---

## COMANDO: `plan`

### DescripciÃ³n
Genera un plan de modernizaciÃ³n arquitectÃ³nica SIN ejecutar cambios. Analiza patterns en el cÃ³digo y propone un stack moderno coherente.

### Sintaxis
```bash
osmosis plan --dir <directory> [--force] [--output <path>]
```

### Flags

| Flag | Tipo | Requerido | Default | DescripciÃ³n |
|------|------|-----------|---------|-------------|
| `--dir` | string | âœ… | - | Directorio del proyecto React |
| `--force` | boolean | âŒ | false | Re-analizar aunque exista manifiesto |
| `--output` | string | âŒ | `.osmosis/architecture-manifest.json` | Ruta del manifiesto |

### Ejemplos

```bash
# Generar plan
osmosis plan --dir ./my-react-app

# Forzar re-anÃ¡lisis
osmosis plan --dir ./my-app --force

# Guardar en ubicaciÃ³n personalizada
osmosis plan --dir ./project --output ./plans/architecture.json
```

### Output Generado

**Archivos**:
- `.osmosis/architecture-manifest.json` - Manifiesto arquitectÃ³nico completo

**Consola**:
```
ğŸ—ï¸ Iniciando planificaciÃ³n arquitectÃ³nica integral...

ğŸ“Š Fase 1: Escaneo profundo del cÃ³digo fuente...
   ğŸ“ 234 archivos encontrados

   ğŸ“ˆ RESUMEN DE PATRONES DETECTADOS:
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ğŸ“ Total archivos: 234
   ğŸ§© Total componentes: 89
   ğŸ“Š Legacy Score: 67/100
   ğŸ—ƒï¸ State Principal: redux-legacy
   ğŸ”„ Fetching Principal: manual
   ğŸ¨ Styling Principal: inline-styles
   âš ï¸ Class Components: 23
   âš ï¸ Redux connect(): 45
   âš ï¸ React Router v5 <Switch>: 12

ğŸ¤– Fase 2: Consultando Arquitecto AI para propuesta de stack...

   ğŸš€ STACK MODERNO PROPUESTO:
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ğŸ—ƒï¸ State: zustand
      â””â”€ Estado simple, no necesita la complejidad de Redux
   ğŸ”„ Fetching: tanstack-query
      â””â”€ Centraliza caching, estados de loading y error
   ğŸ§­ Routing: react-router-v6
      â””â”€ MigraciÃ³n directa desde v5, menos breaking changes
   ğŸ¨ Styling: tailwind
      â””â”€ Elimina inline styles, mejor DX y performance
   ğŸ“ Forms: react-hook-form
   ğŸ§ª Testing: vitest

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“‹ PLAN DE MODERNIZACIÃ“N GENERADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Confianza: 85%
   Reglas de migraciÃ³n: 12
   Dependencias nuevas: 8
   Paquetes a eliminar: 5

ğŸ’¡ Ejecuta para aplicar:
   osmosis refactor --source ./my-react-app --framework react --integral --apply-config
```

---

## COMANDO: `migrate`

### DescripciÃ³n
Migra cÃ³digo legacy (JSP, PHP, jQuery, ASP) a framework moderno (React, Angular, Vue).

### Sintaxis
```bash
osmosis migrate --source <path> --from <tech> --to <tech> [options]
```

### Flags

| Flag | Tipo | Requerido | Default | DescripciÃ³n |
|------|------|-----------|---------|-------------|
| `--source` | string | âœ… | - | Archivo o directorio a migrar |
| `--from` | string | âœ… | - | TecnologÃ­a origen |
| `--to` | string | âœ… | - | TecnologÃ­a destino |
| `--output` | string | âŒ | `./migrated` | Directorio de salida |
| `--client` | string | âŒ | `GenericClient` | Nombre del cliente (contexto) |
| `--design-system` | string | âŒ | - | Path al design system |
| `--dry-run` | boolean | âŒ | false | Simular sin escribir |

### Valores VÃ¡lidos

**`--from`** (legacy):
- `jsp` - JavaServer Pages
- `php` - PHP vanilla o frameworks
- `jquery` - jQuery / vanilla JS
- `asp` - ASP.NET WebForms
- `coldfusion` - ColdFusion
- `perl` - Perl CGI
- `vb` - Visual Basic
- `react-legacy` - React con Class Components

**`--to`** (modern):
- `react` - React 18+ con Hooks
- `angular` - Angular 17+ con Signals
- `vue` - Vue 3 con Composition API

### Ejemplos

```bash
# Migrar directorio completo
osmosis migrate --source ./legacy --from jsp --to react

# Migrar archivo Ãºnico
osmosis migrate --source ./login.php --from php --to react --output ./modern

# Con contexto de cliente
osmosis migrate --source ./bank-app --from jquery --to react --client "Banco Nacional"

# Dry run (ver sin escribir)
osmosis migrate --source ./app --from asp --to react --dry-run
```

### Flujo de MigraciÃ³n

```
1. Detectar tecnologÃ­a legacy (si es directorio)
2. Construir grafo de dependencias
3. Cargar/Construir Knowledge Graph (RAG)
4. Para cada archivo (en orden de dependencias):
   a. Ensamblar prompt con contexto
   b. Enriquecer con RAG (componentes similares)
   c. Generar cÃ³digo con Claude (streaming)
   d. Validar con CodeSafeGuard
   e. Si errores: Auto-repair (max 3 intentos)
   f. Escribir archivo migrado
```

---

## COMANDO: `refactor`

### DescripciÃ³n
Refactoriza cÃ³digo moderno con malas prÃ¡cticas. Puede ser archivo por archivo o en **modo integral** (arquitectÃ³nico).

### Sintaxis
```bash
osmosis refactor --source <path> --framework <name> [options]
```

### Flags

| Flag | Tipo | Requerido | Default | DescripciÃ³n |
|------|------|-----------|---------|-------------|
| `--source` | string | âœ… | - | Archivo o directorio |
| `--framework` | string | âœ… | - | Framework (`react`, `angular`, `vue`) |
| `--output` | string | âŒ | `./refactored` | Directorio de salida |
| `--analyze-only` | boolean | âŒ | false | Solo analizar, no refactorizar |
| `--integral` | boolean | âŒ | false | **Modo arquitectÃ³nico completo** |
| `--manifest` | string | âŒ | - | Usar manifiesto existente |
| `--apply-config` | boolean | âŒ | false | Escribir configuraciÃ³n moderna |
| `--force` | boolean | âŒ | false | Re-analizar aunque exista manifiesto |

### Modo Normal vs Integral

**Modo Normal** (sin `--integral`):
- Refactoriza archivo por archivo
- Reglas estÃ¡ticas de conversiÃ³n
- Sin coherencia global de stack

**Modo Integral** (con `--integral`):
- Analiza proyecto completo primero
- Propone stack coherente
- Genera reglas especÃ­ficas
- Aplica las MISMAS reglas a TODOS los archivos
- Genera configuraciÃ³n moderna

### Ejemplos

```bash
# Modo normal - archivo Ãºnico
osmosis refactor --source ./Dashboard.tsx --framework react

# Modo normal - directorio
osmosis refactor --source ./src/components --framework react

# Modo integral - anÃ¡lisis + refactor + config
osmosis refactor --source ./src --framework react --integral --apply-config

# Solo anÃ¡lisis (ver quÃ© harÃ­a)
osmosis refactor --source ./src --framework react --integral --analyze-only

# Usar manifiesto existente
osmosis refactor --source ./src --framework react --manifest ./custom-manifest.json

# Forzar re-anÃ¡lisis
osmosis refactor --source ./src --framework react --integral --force
```

### Output del Modo Integral

```
ğŸ—ï¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODO ARQUITECTÃ“NICO INTEGRAL
   Analizando proyecto completo para modernizaciÃ³n coherente
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[Fases 1-4 del plan...]

ğŸ“Š RESUMEN DEL ANÃLISIS ARQUITECTÃ“NICO:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Proyecto: mi-proyecto
   Legacy Score: 67/100
   Archivos a procesar: 234
   Reglas de migraciÃ³n: 12

ğŸ“ CONFIGURACIÃ“N APLICADA:
   âœ… Creados: tsconfig.json, eslint.config.js, tailwind.config.ts
   ğŸ“ Actualizados: package.json
   â­ï¸ Omitidos: .prettierrc

ğŸ’¡ Ejecuta para instalar nuevas dependencias:
   npm install

ğŸ”„ INICIANDO REFACTORIZACIÃ“N...

[1/234] Modernizando Dashboard.tsx...
   âœ… Dashboard.tsx modernizado perfectamente

[2/234] Modernizando UserList.tsx...
   âš ï¸ SafeGuard detectÃ³ problemas. Auto-reparando...
   âœ… UserList.tsx reparado y modernizado

...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“Š RESUMEN DE REFACTORIZACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   âœ… Exitosos: 232/234
   âŒ Fallidos: 2/234
   ğŸ“ Output: ./refactored

   ğŸ—ï¸ MODO INTEGRAL:
   â””â”€ Stack: zustand + tanstack-query + react-router-v6
   â””â”€ Reglas aplicadas: 12
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## SCRIPTS NPM

### Desarrollo
```bash
npm run dev              # CLI con hot-reload (tsx watch)
npm run mcp:dev          # MCP server con hot-reload
```

### ProducciÃ³n
```bash
npm run build            # Compilar TypeScript â†’ dist/
npm run start            # Ejecutar CLI compilado
npm run mcp              # Ejecutar MCP server compilado
```

### Testing
```bash
npm test                 # Vitest
npm run test:e2e         # Playwright E2E
```

### Docker
```bash
npm run docker:build     # Construir imagen
npm run docker:up        # Levantar contenedor
npm run docker:down      # Detener contenedor
```

### Atajos de AnÃ¡lisis/MigraciÃ³n
```bash
npm run analyze -- --dir ./project
npm run migrate -- --source ./legacy --from jsp --to react
```

---

## ARCHIVOS GENERADOS

| Archivo | Generado Por | DescripciÃ³n |
|---------|--------------|-------------|
| `analysis-report.json` | `analyze` | Reporte de anÃ¡lisis completo |
| `.osmosis/knowledge-graph.json` | `analyze`, `migrate` | Knowledge Graph RAG |
| `.osmosis/embeddings-cache.json` | `analyze`, `migrate` | Cache de embeddings |
| `.osmosis/architecture-manifest.json` | `plan`, `refactor --integral` | Manifiesto arquitectÃ³nico |
| `./migrated/*.tsx` | `migrate` | CÃ³digo migrado |
| `./refactored/*.tsx` | `refactor` | CÃ³digo refactorizado |
| `tsconfig.json` | `refactor --apply-config` | Config TypeScript |
| `eslint.config.js` | `refactor --apply-config` | Config ESLint flat |
| `tailwind.config.ts` | `refactor --apply-config` | Config Tailwind |
| `vitest.config.ts` | `refactor --apply-config` | Config Vitest |
| `postcss.config.js` | `refactor --apply-config` | Config PostCSS |
| `.prettierrc` | `refactor --apply-config` | Config Prettier |

---

## TROUBLESHOOTING

### "ANTHROPIC_API_KEY no configurada"
```bash
export ANTHROPIC_API_KEY="sk-ant-api03-..."
```

### "No se encontrÃ³ Knowledge Graph"
```bash
# Ejecutar analyze primero
osmosis analyze --dir ./project
```

### "No architecture manifest found"
```bash
# Ejecutar plan primero
osmosis plan --dir ./project
```

### "Rate limit exceeded"
- Esperar 60 segundos
- Reducir concurrencia (archivos procesados)
- Upgradar plan de Anthropic

### "LLM service health check failed"
- Verificar API key
- Verificar conexiÃ³n a internet
- Verificar proxy si aplica
